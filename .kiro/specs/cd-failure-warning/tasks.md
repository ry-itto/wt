# Implementation Plan

## タスク概要

本実装計画は、wtコマンドのcd失敗検出と警告表示機能を段階的に実装するためのタスクリストです。CLI側（TypeScript）とシェル側（zsh）の両方でエラーハンドリングを強化し、ユーザーに明確なフィードバックを提供します。

---

## 実装タスク

- [x] 1. CLI側でのファイル書き込みエラー検出機能を実装
- [x] 1.1 一時ファイル書き込み失敗の検出とエラーハンドリング
  - `writeCdPath()`メソッドに try-catch ブロックを追加
  - `writeFileSync()`の失敗時にエラーを捕捉
  - エラーメッセージを標準エラー出力に表示（赤色、chalk.redを使用）
  - 失敗したディレクトリパスをエラーメッセージに含める
  - エラー発生後、stdoutマーカーメソッドへフォールバック
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 3.1, 3.2_

- [x] 1.2 エラー原因の分類とメッセージ生成
  - 捕捉したエラーオブジェクトからエラーメッセージを抽出
  - エラータイプ（EACCES、ENOSPC など）に応じたメッセージを生成
  - 汎用エラー時は元のエラーメッセージをそのまま表示
  - _Requirements: 2.1, 2.2, 2.3_

- [x] 2. デバッグモードの実装
- [x] 2.1 環境変数によるデバッグモード制御
  - `process.env.WT_DEBUG`の値を検査（'true' の場合に有効化）
  - デバッグモード有効時のみ詳細ログを出力
  - _Requirements: 5.3_

- [x] 2.2 ファイル書き込み成功時のデバッグログ出力
  - デバッグモード有効時、成功した一時ファイルパスをログ出力
  - 対象ディレクトリパスをログ出力
  - ログはグレー色（chalk.gray）で標準エラー出力に表示
  - _Requirements: 5.1, 5.2_

- [x] 2.3 ファイル書き込み失敗時のデバッグログ出力
  - デバッグモード有効時、詳細なエラー情報を出力
  - 一時ファイルパス、エラーオブジェクト、環境変数を含む
  - スタックトレースを出力
  - _Requirements: 5.1, 5.2_

- [x] 3. シェル統合スクリプトでのcd失敗検出機能を実装
- [x] 3.1 シェル関数内のcd失敗検出ロジック追加
  - `wt shell-init`コマンドが生成するシェル関数テンプレートを修正
  - cd実行時に終了コード（`$?`）を検査
  - cd失敗時（終了コードが非ゼロ）にエラーハンドリングを実行
  - _Requirements: 1.1, 3.4_

- [x] 3.2 ディレクトリ存在チェックとエラーメッセージ表示
  - cd失敗時、`[[ ! -d "$new_dir" ]]`でディレクトリ存在を確認
  - ディレクトリが存在しない場合、専用の警告メッセージを表示
  - 警告メッセージは標準エラー出力（`>&2`）に出力
  - _Requirements: 1.2, 1.3, 2.1_

- [x] 3.3 アクセス権限エラーの検出とメッセージ表示
  - ディレクトリが存在する場合、`[[ ! -r "$new_dir" ]]`で読み取り権限を確認
  - 読み取り権限がない場合、専用の警告メッセージを表示
  - `[[ ! -x "$new_dir" ]]`で実行権限を確認
  - 実行権限がない場合、専用の警告メッセージを表示
  - _Requirements: 1.2, 1.3, 2.2_

- [x] 3.4 汎用cd失敗エラーメッセージの表示
  - 上記の特定エラーに該当しない場合、汎用エラーメッセージを表示
  - エラーメッセージにディレクトリパスを含める
  - _Requirements: 1.2, 1.3, 2.3_

- [x] 4. シェル統合スクリプトの生成ロジック更新
- [x] 4.1 shell-initコマンドの出力テンプレート修正
  - `wt shell-init`コマンドの実装箇所を特定
  - 環境変数メソッド用のシェル関数テンプレートにcd失敗検出ロジックを追加
  - stdoutマーカーメソッド用のシェル関数テンプレートにcd失敗検出ロジックを追加
  - _Requirements: 3.3, 3.4_

- [x] 4.2 既存のシェル関数との互換性確保
  - 正常系のcd成功時の動作に影響を与えないことを確認
  - cd成功時はエラーメッセージを表示しないことを確認
  - 一時ファイルのクリーンアップが正常に動作することを確認
  - _Requirements: 4.2_

- [ ] 5. エラーハンドリングのテストを実装
- [ ] 5.1 CLI側のユニットテスト作成
  - `writeCdPath()`メソッドのファイル書き込み失敗をモック
  - エラーメッセージが正しく表示されることをテスト
  - stdoutマーカーへのフォールバックが動作することをテスト
  - デバッグモード有効時の詳細ログ出力をテスト
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 3.2, 5.1, 5.2, 5.3_

- [ ] 5.2 シェル側の統合テスト作成
  - 存在しないディレクトリへのcd試行をテスト
  - アクセス権限のないディレクトリへのcd試行をテスト
  - 正常なcd実行が影響を受けないことをテスト
  - エラーメッセージが標準エラー出力に表示されることをテスト
  - _Requirements: 1.1, 1.2, 2.1, 2.2, 2.3, 3.4_

- [ ] 5.3 E2Eテストの作成
  - 実際のwtコマンド実行からcd失敗までの全フローをテスト
  - 環境変数メソッドとstdoutマーカーメソッドの両方でテスト
  - デバッグモード有効時のE2Eフローをテスト
  - _Requirements: All requirements_

- [x] 6. プロセス終了コードの適切な設定
- [x] 6.1 CLI側の終了コード設定
  - ファイル書き込み失敗時、適切な非ゼロ終了コードを設定
  - 既存の終了コード設定ロジックと整合性を保つ
  - プロセスがクラッシュしないことを確認
  - _Requirements: 4.1, 4.3_

- [x] 6.2 シェル側の終了コード伝播
  - cd失敗時、シェル関数が適切に終了コードを保持
  - ユーザーが元のディレクトリに留まることを確認
  - _Requirements: 4.2_

- [x] 7. ドキュメント更新(コード内コメントのみ)
- [x] 7.1 CLI側のコード内コメント追加
  - `writeCdPath()`メソッドのエラーハンドリングロジックにコメントを追加
  - デバッグモードの動作をコメントで説明
  - _Requirements: All requirements_

- [x] 7.2 シェル統合スクリプトのコード内コメント追加
  - cd失敗検出ロジックにコメントを追加
  - エラー分類ロジックにコメントを追加
  - _Requirements: All requirements_
